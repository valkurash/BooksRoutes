# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: CmdLine@2
  inputs:
    script: |
      echo "module.exports = {
        db_test:
          "postgres://valkurash:Booksroutes2018postgres@84.201.156.161:5432/books_routes_test?tcp_keepalives_idle=600",
        db_dev:
          "postgres://valkurash:Booksroutes2018postgres@84.201.156.161:5432/books_routes_dev?tcp_keepalives_idle=600",
        db_prod:
          "postgres://valkurash:Booksroutes2018postgres@84.201.156.161:5432/books_routes?tcp_keepalives_idle=600"
      };">db_strings.js
    workingDirectory: 'books-routes-api'
- task: Docker@2
  inputs:
    containerRegistry: 'gutester'
    repository: 'booksroutes-api'
    tags: |
      latest
    command: 'buildAndPush'
    Dockerfile: 'books-routes-api/DockerFile'
    
- task: Docker@2
  inputs:
    containerRegistry: 'gutester'
    repository: 'booksroutes-app'
    tags: |
      latest
    command: 'buildAndPush'
    Dockerfile: 'books-routes-app/DockerFile'
